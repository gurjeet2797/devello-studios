import aiService, { AI_TOOLS } from '../../../lib/aiService.js';
import { withMiddleware } from '../../../lib/middleware.js';
import { createLogger } from '../../../lib/logger.js';
import { enhancedPromptGenerator } from '../../../lib/enhancedPromptGenerator.js';

const logger = createLogger('general-edit-api');

const handler = async (req, res) => {
  const timer = logger.startTimer('general-edit-prediction');
  
  try {
    const { image, prompt, customPrompt, hotspots, imageContext } = req.body;

    if (!image) {
      return res.status(400).json({ error: "No input image provided" });
    }

    if (!prompt && !customPrompt) {
      return res.status(400).json({ error: "No prompt provided" });
    }

    logger.info('Creating general edit prediction', { 
      hasCustomPrompt: !!customPrompt,
      hasPrompt: !!prompt,
      hotspotCount: hotspots?.length || 0,
      hasImageContext: !!imageContext
    });

    // Phase 3: Enhanced prompt generation with context awareness
    let finalPrompt;
    if (customPrompt) {
      // Use enhanced prompt generator for custom prompts
      finalPrompt = enhancedPromptGenerator.generateEnhancedPrompt(
        hotspots || [], 
        imageContext, 
        customPrompt
      );
    } else if (prompt) {
      // Use enhanced prompt generator for standard prompts
      finalPrompt = enhancedPromptGenerator.generateEnhancedPrompt(
        hotspots || [], 
        imageContext, 
        prompt
      );
    } else {
      // Use enhanced prompt generator with default behavior
      finalPrompt = enhancedPromptGenerator.generateEnhancedPrompt(
        hotspots || [], 
        imageContext
      );
    }

    // Validate hotspots if provided
    if (hotspots && hotspots.length > 0) {
      const validation = enhancedPromptGenerator.validateHotspots(hotspots, imageContext);
      if (!validation.isValid) {
        logger.warn('Hotspot validation failed', { validation });
      }
      if (validation.warnings.length > 0) {
        logger.info('Hotspot validation warnings', { warnings: validation.warnings });
      }
    }

    // Log the final prompt that will be sent to Gemini
    console.log('General edit request:', {
      hasCustomPrompt: !!customPrompt,
      hasPrompt: !!prompt,
      basePrompt: customPrompt ? 'Using custom prompt' : aiService.getPrompt(AI_TOOLS.GENERAL_EDIT, 'default'),
      finalPrompt,
      imageUrl: image
    });

    // Use Gemini for image processing
    const prediction = await aiService.createGeminiPrediction(AI_TOOLS.GENERAL_EDIT, {
      image,
      customPrompt: finalPrompt
    });

    timer.end('General edit prediction created successfully');
    
    logger.info('General edit prediction created', { 
      id: prediction.id,
      status: prediction.status,
      promptLength: finalPrompt.length
    });

    // For Gemini, return the result immediately since it's not async
    if (prediction.status === 'succeeded') {
      return res.status(200).json(prediction);
    } else {
      // This shouldn't happen with Gemini, but handle it just in case
      return res.status(200).json(prediction);
    }
    
  } catch (error) {
    timer.end('General edit prediction failed');
    logger.error('General edit prediction error', { 
      error: error.message,
      stack: error.stack,
      name: error.name
    });
    
    // Check if it's an API key issue
    if (error.message.includes('API key') || error.message.includes('GOOGLE_API_KEY')) {
      return res.status(500).json({ 
        error: "Google API key not configured. Please check environment variables.",
        message: error.message 
      });
    }
    
    return res.status(500).json({ 
      error: "Error processing general edit prediction",
      message: error.message 
    });
  }
};

export default withMiddleware(handler, {
  validation: {
    method: 'POST',
    requireBody: true,
    requiredFields: ['image']
  }
});
